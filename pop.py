import json
import rasterio
from rasterio.mask import mask

spanishPopRaster = rasterio.open("./data/spain_pop.tif")

def calcPop(poly):
    # Pedralba (stringified GeoJSON from GET)
    #poly = '{\"bbox\":[-0.846283,39.472425,-0.555225,39.723291],\"features\":[{\"geometry\":{\"coordinates\":[[[-0.846283,39.603575],[-0.844884,39.600258],[-0.836174,39.598116],[-0.830987,39.593613],[-0.82856,39.588661],[-0.828438,39.579823],[-0.828495,39.579529],[-0.827228,39.574873],[-0.827081,39.574464],[-0.823719,39.574473],[-0.816171,39.573549],[-0.811841,39.569961],[-0.80914,39.568821],[-0.805701,39.568074],[-0.805489,39.568083],[-0.804639,39.571382],[-0.808099,39.574017],[-0.813214,39.576082],[-0.817281,39.579757],[-0.819031,39.582622],[-0.82078,39.587795],[-0.825007,39.598888],[-0.824023,39.60743],[-0.820775,39.610732],[-0.814447,39.615517],[-0.811988,39.617212],[-0.809114,39.618929],[-0.802235,39.618802],[-0.79754,39.613876],[-0.795324,39.612467],[-0.790056,39.601993],[-0.789799,39.599105],[-0.790699,39.590775],[-0.789802,39.584764],[-0.788941,39.58221],[-0.788102,39.581943],[-0.784539,39.581429],[-0.78447,39.581906],[-0.785479,39.592617],[-0.78428,39.595197],[-0.778404,39.604925],[-0.770052,39.607618],[-0.766205,39.60123],[-0.765447,39.601218],[-0.764682,39.601332],[-0.754185,39.599641],[-0.751496,39.599495],[-0.748957,39.5989],[-0.746371,39.598725],[-0.741946,39.587776],[-0.750126,39.579026],[-0.752688,39.577934],[-0.755316,39.577189],[-0.765705,39.573918],[-0.768383,39.573773],[-0.770042,39.57079],[-0.769757,39.570446],[-0.7693,39.570257],[-0.767567,39.569502],[-0.762627,39.569374],[-0.759647,39.56989],[-0.757157,39.5706],[-0.752129,39.574002],[-0.745233,39.574885],[-0.742284,39.575943],[-0.734684,39.574298],[-0.728666,39.567147],[-0.735725,39.561828],[-0.737395,39.557897],[-0.731265,39.549445],[-0.731672,39.546936],[-0.732678,39.54145],[-0.733585,39.538073],[-0.742858,39.532864],[-0.749932,39.530879],[-0.75006,39.530822],[-0.748708,39.527285],[-0.759325,39.523062],[-0.762237,39.520946],[-0.762439,39.511834],[-0.761372,39.511457],[-0.758134,39.509833],[-0.752766,39.502587],[-0.745947,39.501882],[-0.744154,39.505003],[-0.746375,39.507167],[-0.745307,39.517553],[-0.736302,39.5177],[-0.733686,39.514652],[-0.731584,39.512503],[-0.729026,39.51163],[-0.722757,39.506972],[-0.717282,39.499003],[-0.71496,39.496251],[-0.708322,39.491249],[-0.707304,39.490518],[-0.704076,39.479788],[-0.706533,39.478255],[-0.707349,39.477746],[-0.706387,39.475119],[-0.706263,39.475057],[-0.705442,39.474692],[-0.696189,39.472425],[-0.692601,39.472719],[-0.688624,39.475928],[-0.683056,39.481536],[-0.67274,39.481358],[-0.663321,39.479278],[-0.659937,39.478853],[-0.658793,39.481507],[-0.658886,39.482297],[-0.660937,39.483322],[-0.664122,39.488319],[-0.655465,39.496258],[-0.652981,39.497738],[-0.651247,39.498542],[-0.643238,39.503827],[-0.642944,39.507415],[-0.644383,39.507628],[-0.646714,39.508347],[-0.650944,39.51822],[-0.642954,39.522914],[-0.640289,39.522394],[-0.63899,39.521855],[-0.637203,39.524981],[-0.634634,39.530719],[-0.628961,39.535456],[-0.628144,39.535824],[-0.628609,39.539039],[-0.629078,39.548717],[-0.618321,39.552911],[-0.616607,39.552018],[-0.613555,39.550338],[-0.609079,39.549676],[-0.60764,39.549312],[-0.600243,39.548095],[-0.596958,39.546816],[-0.594497,39.546303],[-0.59049,39.545214],[-0.583738,39.542261],[-0.580209,39.54297],[-0.578333,39.544816],[-0.577142,39.546366],[-0.57706,39.546523],[-0.577295,39.548264],[-0.578469,39.549842],[-0.581905,39.553016],[-0.582686,39.55387],[-0.587437,39.561369],[-0.589557,39.563496],[-0.586873,39.574091],[-0.583996,39.576255],[-0.579926,39.579309],[-0.578576,39.580766],[-0.578489,39.580974],[-0.578397,39.581564],[-0.574216,39.591912],[-0.571406,39.592408],[-0.563309,39.600202],[-0.56191,39.601016],[-0.560667,39.602647],[-0.557003,39.612455],[-0.555225,39.615584],[-0.558961,39.618834],[-0.559205,39.618936],[-0.560602,39.615619],[-0.56945,39.610397],[-0.569816,39.610282],[-0.570466,39.609989],[-0.570538,39.609945],[-0.578567,39.608717],[-0.578727,39.608755],[-0.585352,39.617953],[-0.5835,39.621039],[-0.587466,39.62511],[-0.589628,39.627927],[-0.590242,39.628626],[-0.590419,39.628732],[-0.592594,39.628993],[-0.601137,39.630691],[-0.603708,39.635982],[-0.605583,39.639056],[-0.606353,39.638586],[-0.611071,39.636026],[-0.622669,39.63705],[-0.626202,39.645189],[-0.628347,39.646374],[-0.632141,39.648466],[-0.63507,39.650069],[-0.638385,39.651861],[-0.642332,39.654041],[-0.64595,39.656026],[-0.648744,39.657617],[-0.652408,39.6596],[-0.65482,39.660931],[-0.662395,39.66737],[-0.664334,39.670403],[-0.674892,39.672242],[-0.683656,39.678882],[-0.686454,39.683925],[-0.687016,39.684419],[-0.690463,39.687424],[-0.696724,39.694202],[-0.698438,39.697369],[-0.700361,39.700917],[-0.701595,39.704298],[-0.69983,39.715363],[-0.696758,39.72075],[-0.697152,39.721738],[-0.69905,39.723291],[-0.699389,39.723208],[-0.699582,39.723001],[-0.699853,39.722641],[-0.70313,39.7168],[-0.712513,39.710259],[-0.720093,39.711731],[-0.728696,39.709246],[-0.733654,39.711553],[-0.736347,39.712925],[-0.739174,39.714635],[-0.743453,39.715039],[-0.743805,39.715081],[-0.744227,39.711505],[-0.749116,39.70376],[-0.758252,39.7046],[-0.761501,39.704641],[-0.770295,39.704057],[-0.779069,39.703474],[-0.783146,39.703246],[-0.787223,39.703019],[-0.787022,39.699425],[-0.782946,39.699652],[-0.778869,39.699879],[-0.770056,39.700465],[-0.761263,39.701049],[-0.758496,39.701008],[-0.749446,39.700175],[-0.738546,39.699167],[-0.7385,39.691078],[-0.738547,39.690875],[-0.739185,39.685596],[-0.73909,39.676804],[-0.742852,39.668682],[-0.743303,39.666589],[-0.74385,39.66306],[-0.743867,39.662623],[-0.746751,39.654146],[-0.747306,39.653249],[-0.747502,39.650254],[-0.748851,39.642643],[-0.758218,39.642177],[-0.760875,39.64431],[-0.762802,39.651232],[-0.759867,39.658014],[-0.758558,39.658907],[-0.757871,39.659556],[-0.760344,39.662172],[-0.762674,39.66077],[-0.76605,39.658129],[-0.775368,39.656783],[-0.784142,39.663105],[-0.782794,39.666443],[-0.790673,39.67369],[-0.792774,39.677368],[-0.79412,39.679971],[-0.795466,39.68286],[-0.798903,39.681791],[-0.800393,39.67011],[-0.805703,39.659778],[-0.806699,39.65968],[-0.814242,39.650525],[-0.817315,39.648649],[-0.817179,39.645135],[-0.81575,39.638214],[-0.812391,39.636917],[-0.807798,39.633475],[-0.807282,39.62525],[-0.809311,39.622523],[-0.814438,39.620243],[-0.816653,39.618548],[-0.819555,39.617294],[-0.821883,39.615196],[-0.833848,39.615411],[-0.837983,39.617046],[-0.838876,39.616313],[-0.83971,39.613033],[-0.846283,39.603575]]],\"type\":\"Polygon\"},\"properties\":{\"center\":[-0.7300682836938235,39.6051133342998],\"group_index\":0,\"value\":960},\"type\":\"Feature\"}],\"metadata\":{\"attribution\":\"openrouteservice.org | OpenStreetMap contributors\",\"engine\":{\"build_date\":\"2021-12-16T11:22:41Z\",\"graph_date\":\"2021-12-30T00:30:23Z\",\"version\":\"6.6.3\"},\"query\":{\"locations\":[[-0.73,39.605083]],\"range\":[960]},\"service\":\"isochrones\",\"timestamp\":1641558418603},\"type\":\"FeatureCollection\"}'
    
    # Poly out of spain to force exception
    #poly = '{\"bbox\":[2.860127,42.172729,3.095638,42.389711],\"features\":[{\"geometry\":{\"coordinates\":[[[2.860127,42.308326],[2.861974,42.308163],[2.863821,42.308001],[2.873275,42.303056],[2.874948,42.299868],[2.88309,42.296804],[2.885883,42.293654],[2.889418,42.285463],[2.889783,42.281881],[2.892173,42.281869],[2.899893,42.274302],[2.901089,42.271715],[2.901307,42.271714],[2.909344,42.269051],[2.916836,42.272058],[2.918906,42.271962],[2.922807,42.261134],[2.916012,42.253314],[2.912566,42.253836],[2.910422,42.254572],[2.910234,42.254573],[2.909151,42.251943],[2.902468,42.242632],[2.903599,42.239215],[2.90617,42.239836],[2.910187,42.239915],[2.913944,42.239038],[2.918601,42.241061],[2.920574,42.241137],[2.923274,42.240462],[2.927964,42.236138],[2.923214,42.225594],[2.923177,42.225164],[2.923996,42.222766],[2.924029,42.222662],[2.925209,42.220912],[2.925872,42.220165],[2.927698,42.219812],[2.935036,42.219455],[2.937751,42.211054],[2.936674,42.208187],[2.934815,42.204534],[2.93304,42.201137],[2.931919,42.198654],[2.931041,42.196022],[2.930476,42.192642],[2.930551,42.189347],[2.93104,42.186112],[2.929381,42.174683],[2.932405,42.172729],[2.932792,42.173328],[2.933858,42.175361],[2.934745,42.177932],[2.935173,42.180663],[2.935077,42.183683],[2.934588,42.186723],[2.934124,42.189783],[2.935914,42.198801],[2.937128,42.201222],[2.938868,42.204486],[2.940277,42.207433],[2.941214,42.210071],[2.942042,42.21401],[2.950557,42.219008],[2.951999,42.219077],[2.952133,42.21915],[2.952476,42.21943],[2.956254,42.223608],[2.967544,42.221272],[2.968118,42.21993],[2.976894,42.221269],[2.981661,42.222522],[2.98984,42.223067],[2.990976,42.223564],[3.002861,42.223519],[3.005363,42.222347],[3.012751,42.217498],[3.014521,42.216597],[3.022796,42.214105],[3.024333,42.21736],[3.021673,42.218616],[3.019804,42.219314],[3.016995,42.22099],[3.008647,42.228477],[3.008081,42.232032],[3.014728,42.238889],[3.016719,42.23999],[3.028137,42.242179],[3.029084,42.242685],[3.041001,42.243407],[3.045776,42.243455],[3.047918,42.246348],[3.052784,42.251248],[3.055335,42.252948],[3.065076,42.253574],[3.073539,42.246054],[3.073802,42.245576],[3.084327,42.250747],[3.08326,42.254185],[3.073454,42.255098],[3.065082,42.260333],[3.060095,42.26122],[3.058409,42.272853],[3.057595,42.27339],[3.057092,42.273765],[3.054982,42.275575],[3.051721,42.286337],[3.055629,42.294326],[3.057972,42.297059],[3.064769,42.304214],[3.070034,42.307478],[3.071754,42.310641],[3.076063,42.321628],[3.077284,42.321469],[3.080446,42.321307],[3.089246,42.324971],[3.090974,42.325567],[3.092024,42.328157],[3.092028,42.328301],[3.09226,42.339262],[3.095183,42.342815],[3.095358,42.343175],[3.095638,42.343766],[3.092384,42.345306],[3.082449,42.341051],[3.074102,42.339183],[3.070893,42.339144],[3.070608,42.338315],[3.069428,42.335856],[3.065962,42.332094],[3.060123,42.322023],[3.04917,42.32515],[3.047934,42.333103],[3.05044,42.338763],[3.056891,42.341625],[3.057555,42.341916],[3.058003,42.342183],[3.056802,42.344766],[3.056562,42.34501],[3.056158,42.345274],[3.053709,42.345626],[3.053019,42.345715],[3.048174,42.345272],[3.046812,42.34457],[3.043488,42.343187],[3.035357,42.347066],[3.034516,42.351576],[3.034237,42.352517],[3.030785,42.351495],[3.028097,42.345038],[3.028626,42.34261],[3.029411,42.341686],[3.035256,42.333605],[3.030239,42.32888],[3.02256,42.327838],[3.019002,42.328384],[3.014788,42.329481],[3.013133,42.330227],[3.007721,42.33729],[3.005624,42.343568],[3.005658,42.351451],[3.004802,42.353321],[3.001723,42.361304],[3.001653,42.361537],[3.000449,42.364352],[3.000379,42.364413],[3.000116,42.364612],[2.99188,42.371298],[2.990865,42.375973],[2.993666,42.383477],[2.999602,42.387124],[2.999689,42.387214],[2.997096,42.389711],[2.987309,42.385327],[2.98089,42.385447],[2.980455,42.385439],[2.976921,42.378521],[2.967761,42.371659],[2.964259,42.370826],[2.954547,42.37496],[2.952171,42.378988],[2.950861,42.382341],[2.945239,42.386701],[2.944732,42.38721],[2.942179,42.384672],[2.938681,42.375762],[2.930881,42.373489],[2.925496,42.375147],[2.925317,42.375162],[2.924998,42.371577],[2.930822,42.369011],[2.942133,42.365458],[2.94425,42.363011],[2.94497,42.362178],[2.945589,42.351084],[2.943359,42.348258],[2.942797,42.34476],[2.934883,42.337785],[2.924511,42.339876],[2.922613,42.341321],[2.919916,42.344508],[2.915073,42.348244],[2.911173,42.352132],[2.909271,42.362619],[2.910534,42.365263],[2.910609,42.365728],[2.910653,42.366483],[2.907059,42.366695],[2.898029,42.366151],[2.891713,42.371472],[2.89047,42.374149],[2.888076,42.378549],[2.884558,42.377784],[2.88471,42.377085],[2.885045,42.376053],[2.886291,42.373761],[2.888288,42.370362],[2.888441,42.360322],[2.88965,42.357733],[2.889684,42.357727],[2.898359,42.353552],[2.900826,42.350411],[2.905114,42.34744],[2.900475,42.337608],[2.896249,42.33928],[2.89537,42.339592],[2.891522,42.340061],[2.890669,42.33988],[2.888205,42.338662],[2.888468,42.338039],[2.890245,42.336305],[2.894053,42.334241],[2.896472,42.331529],[2.89958,42.325708],[2.891367,42.319199],[2.890841,42.319193],[2.89068,42.319036],[2.890831,42.315593],[2.893172,42.305688],[2.890338,42.303468],[2.882315,42.305049],[2.880062,42.306257],[2.877073,42.307741],[2.874732,42.30864],[2.871907,42.309969],[2.867984,42.311411],[2.867714,42.311423],[2.864137,42.311587],[2.86229,42.311749],[2.860443,42.311912],[2.860127,42.308326]]],\"type\":\"Polygon\"},\"properties\":{\"center\":[2.9633637134510717,42.27420567452312],\"group_index\":0,\"value\":960},\"type\":\"Feature\"}],\"metadata\":{\"attribution\":\"openrouteservice.org | OpenStreetMap contributors\",\"engine\":{\"build_date\":\"2021-12-16T11:22:41Z\",\"graph_date\":\"2021-12-30T00:30:23Z\",\"version\":\"6.6.3\"},\"query\":{\"locations\":[[2.96356201171875,42.274260416436476]],\"range\":[960]},\"service\":\"isochrones\",\"timestamp\":1641559626624},\"type\":\"FeatureCollection\"}'

    # Convert string to JSON
    geoJSON = json.loads(poly)

    # Load population raster, mask it by the polygon and crop it
    try:
        out_image, out_transform = mask(spanishPopRaster, [geoJSON], crop=True)
        #out_meta = src.meta.copy()
        # Clean negative values
        out_image = out_image[out_image>=0]

        # Get total population
        totalPop = int(out_image.sum())
        #print(totalPop)
        return {'total_population': totalPop}
    except ValueError as error:
        #print("Error:",error)
        return {
            "error": error 
        }
